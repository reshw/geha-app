rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====

    // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
    function isAuthenticated() {
      return request.auth != null;
    }

    // ì‚¬ìš©ì ID í™•ì¸
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ìŠ¤í˜ì´ìŠ¤ ê´€ë¦¬ì/ë¶€ë§¤ë‹ˆì € ê¶Œí•œ í™•ì¸
    function hasSpacePermission(spaceId, requiredRole) {
      let spaceAccess = get(/databases/$(database)/documents/users/$(request.auth.uid)/spaceAccess/$(spaceId)).data;
      return isAuthenticated() &&
             spaceAccess != null &&
             (spaceAccess.userType == requiredRole ||
              spaceAccess.userType == 'manager');
    }

    // ì˜ˆì•½ ì·¨ì†Œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    function canCancelReservation(reserveData) {
      // 1. ì²´í¬ì¸ ë‚ ì§œê°€ í˜„ì¬ ì‹œê°„ë³´ë‹¤ ë¯¸ë˜ì—¬ì•¼ í•¨
      let checkInDate = reserveData.checkIn;
      let isFutureReservation = checkInDate > request.time;

      // 2. ì²´í¬ì¸ ì™„ë£Œ ìƒíƒœê°€ ì•„ë‹ˆì–´ì•¼ í•¨
      let isNotCheckedIn = !('status' in reserveData) || reserveData.status != 'checked-in';

      return isFutureReservation && isNotCheckedIn;
    }

    // ì˜ˆì•½ ìˆ˜ì • ì‹œ ì‹œì‘ì¼ ë³€ê²½ ë¶ˆê°€ ê²€ì¦
    function canUpdateCheckIn(oldData, newData) {
      let oldCheckIn = oldData.checkIn;
      let newCheckIn = newData.checkIn;

      // ì›ë³¸ ì˜ˆì•½ì´ ì´ë¯¸ ì‹œì‘ëœ ê²½ìš° (ê³¼ê±°)
      let isStarted = oldCheckIn < request.time;

      // ì‹œì‘ì¼ ë³€ê²½ ì—¬ë¶€ í™•ì¸ (1ì´ˆ ì´ìƒ ì°¨ì´)
      let checkInChanged = (newCheckIn.toMillis() - oldCheckIn.toMillis()).abs() > 1000;

      // ì´ë¯¸ ì‹œì‘ëœ ì˜ˆì•½ì˜ ì‹œì‘ì¼ì„ ë³€ê²½í•˜ë ¤ê³  í•˜ë©´ false
      return !(isStarted && checkInChanged);
    }

    // ===== Users Collection =====
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);

      match /spaceAccess/{spaceId} {
        allow read: if isUser(userId);
        allow write: if isUser(userId);
      }
    }

    // ===== Spaces Collection =====
    match /spaces/{spaceId} {
      allow read: if isAuthenticated();
      allow write: if hasSpacePermission(spaceId, 'manager');

      // ìŠ¤í˜ì´ìŠ¤ ë©¤ë²„
      match /assignedUsers/{userId} {
        allow read: if isAuthenticated();
        allow write: if hasSpacePermission(spaceId, 'manager');
      }

      // ì˜ˆì•½ (reserves)
      match /reserves/{reserveId} {
        // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
        allow read: if isAuthenticated();

        // ìƒì„±: ê´€ë¦¬ì/ë¶€ë§¤ë‹ˆì €ë§Œ
        allow create: if hasSpacePermission(spaceId, 'vice-manager');

        // ğŸ”’ ìˆ˜ì •: ê´€ë¦¬ì/ë¶€ë§¤ë‹ˆì €ë§Œ
        // ì·¨ì†ŒëŠ” updateë¡œ ì²˜ë¦¬ (statusë¥¼ 'canceled'ë¡œ ë³€ê²½)
        // ì´ë¯¸ ì‹œì‘ëœ ì˜ˆì•½ì˜ ì‹œì‘ì¼ì€ ë³€ê²½ ë¶ˆê°€
        allow update: if hasSpacePermission(spaceId, 'vice-manager')
                      && canUpdateCheckIn(resource.data, request.resource.data)
                      && (
                        // ì¼ë°˜ ìˆ˜ì •
                        request.resource.data.status != 'canceled' ||
                        // ì·¨ì†Œ ì²˜ë¦¬ (ê²€ì¦ í†µê³¼ ì‹œì—ë§Œ)
                        (request.resource.data.status == 'canceled' && canCancelReservation(resource.data))
                      );

        // ğŸš« ì‚­ì œ ê¸ˆì§€: Soft Deleteë§Œ í—ˆìš© (ì‹¤ì œ ì‚­ì œ ë¶ˆê°€)
        allow delete: if false;

        // ğŸ“œ ì˜ˆì•½ ë³€ê²½ ì´ë ¥ (ì„œë¸Œì»¬ë ‰ì…˜)
        match /history/{historyId} {
          // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
          allow read: if isAuthenticated();

          // ìƒì„±: ê´€ë¦¬ì/ë¶€ë§¤ë‹ˆì €ë§Œ (ìë™ ìƒì„±)
          allow create: if hasSpacePermission(spaceId, 'vice-manager');

          // ìˆ˜ì •/ì‚­ì œ ê¸ˆì§€: ì´ë ¥ì€ ë¶ˆë³€
          allow update, delete: if false;
        }
      }

      // ì •ì‚° (settlement)
      match /settlement/{weekId} {
        allow read: if isAuthenticated();
        allow write: if hasSpacePermission(spaceId, 'vice-manager');

        match /receipts/{receiptId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
        }
      }

      // ì„¤ì • (settings)
      match /settings/{settingId} {
        allow read: if isAuthenticated();
        allow write: if hasSpacePermission(spaceId, 'manager');
      }

      // ê²ŒìŠ¤íŠ¸ ì •ì±… (guestPolicies)
      match /guestPolicies/{policyId} {
        allow read: if isAuthenticated();
        allow write: if hasSpacePermission(spaceId, 'manager');
      }

      // ì‹œì¦Œì•„ì›ƒ (seasonOuts)
      // ë¬¸ì„œ ID = userId (ìœ ì €ë‹¹ 1ê°œ)
      match /seasonOuts/{userId} {
        // ì½ê¸°: ì¸ì¦ëœ ëª¨ë“  ì‚¬ìš©ì
        allow read: if isAuthenticated();
        // ì“°ê¸°/ì‚­ì œ: ë³¸ì¸ ë¬¸ì„œë§Œ
        allow write, delete: if isUser(userId);
      }
    }

    // ===== ì¹´í’€ ì‹œìŠ¤í…œ =====

    // ì¹´í’€ ìŠ¤í‚¤ì¥ ì •ë³´ (carpool_resorts)
    match /carpool_resorts/{resortId} {
      // ì½ê¸°: ëª¨ë‘ í—ˆìš© (ê³µê°œ ì •ë³´)
      allow read: if true;
      // ì“°ê¸°: ìŠˆí¼ì–´ë“œë¯¼ë§Œ (ì•±ì—ì„œëŠ” ê´€ë¦¬í•˜ì§€ ì•ŠìŒ)
      allow write: if false;
    }

    // ì¹´í’€ í¬ìŠ¤íŠ¸ (carpool_posts)
    match /carpool_posts/{postId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if isAuthenticated();

      // ìƒì„±: ì¸ì¦ëœ ì‚¬ìš©ì + userId ì¼ì¹˜ í™•ì¸
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;

      // ìˆ˜ì •: ë³¸ì¸ë§Œ + userId ë³€ê²½ ë¶ˆê°€
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == resource.data.userId;

      // ì‚­ì œ: Soft Delete ê¶Œì¥ (ì‹¤ì œ ì‚­ì œëŠ” ê¸ˆì§€)
      allow delete: if false;
    }

    // ì‚¬ìš©ìë³„ ìŠ¤í‚¤ì¥ ì ‘ê·¼ ì •ë³´ (users/{userId}/resortAccess)
    match /users/{userId}/resortAccess/{resortId} {
      allow read: if isUser(userId);
      allow write: if isUser(userId);
    }
  }
}
