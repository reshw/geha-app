rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== Helper Functions =====

    // ì‚¬ìš©ì ì¸ì¦ í™•ì¸
    function isAuthenticated() {
      return request.auth != null;
    }

    // ì‚¬ìš©ì ID í™•ì¸
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ìŠ¤í˜ì´ìŠ¤ ê´€ë¦¬ì/ë¶€ë§¤ë‹ˆì € ê¶Œí•œ í™•ì¸
    function hasSpacePermission(spaceId, requiredRole) {
      let spaceAccess = get(/databases/$(database)/documents/users/$(request.auth.uid)/spaceAccess/$(spaceId)).data;
      return isAuthenticated() &&
             spaceAccess != null &&
             (spaceAccess.userType == requiredRole ||
              spaceAccess.userType == 'manager');
    }

    // ì˜ˆì•½ ì·¨ì†Œ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
    function canCancelReservation(reserveData) {
      // 1. ì²´í¬ì¸ ë‚ ì§œê°€ í˜„ì¬ ì‹œê°„ë³´ë‹¤ ë¯¸ë˜ì—¬ì•¼ í•¨
      let checkInDate = reserveData.checkIn;
      let isFutureReservation = checkInDate > request.time;

      // 2. ì²´í¬ì¸ ì™„ë£Œ ìƒíƒœê°€ ì•„ë‹ˆì–´ì•¼ í•¨
      let isNotCheckedIn = !('status' in reserveData) || reserveData.status != 'checked-in';

      return isFutureReservation && isNotCheckedIn;
    }

    // ===== Users Collection =====
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId);

      match /spaceAccess/{spaceId} {
        allow read: if isUser(userId);
        allow write: if isUser(userId);
      }
    }

    // ===== Spaces Collection =====
    match /spaces/{spaceId} {
      allow read: if isAuthenticated();
      allow write: if hasSpacePermission(spaceId, 'manager');

      // ìŠ¤í˜ì´ìŠ¤ ë©¤ë²„
      match /assignedUsers/{userId} {
        allow read: if isAuthenticated();
        allow write: if hasSpacePermission(spaceId, 'manager');
      }

      // ì˜ˆì•½ (reserves)
      match /reserves/{reserveId} {
        // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
        allow read: if isAuthenticated();

        // ìƒì„±: ê´€ë¦¬ì/ë¶€ë§¤ë‹ˆì €ë§Œ
        allow create: if hasSpacePermission(spaceId, 'vice-manager');

        // ğŸ”’ ìˆ˜ì •: ê´€ë¦¬ì/ë¶€ë§¤ë‹ˆì €ë§Œ
        // ì·¨ì†ŒëŠ” updateë¡œ ì²˜ë¦¬ (statusë¥¼ 'canceled'ë¡œ ë³€ê²½)
        allow update: if hasSpacePermission(spaceId, 'vice-manager')
                      && (
                        // ì¼ë°˜ ìˆ˜ì •
                        request.resource.data.status != 'canceled' ||
                        // ì·¨ì†Œ ì²˜ë¦¬ (ê²€ì¦ í†µê³¼ ì‹œì—ë§Œ)
                        (request.resource.data.status == 'canceled' && canCancelReservation(resource.data))
                      );

        // ğŸš« ì‚­ì œ ê¸ˆì§€: Soft Deleteë§Œ í—ˆìš© (ì‹¤ì œ ì‚­ì œ ë¶ˆê°€)
        allow delete: if false;
      }

      // ì •ì‚° (settlement)
      match /settlement/{weekId} {
        allow read: if isAuthenticated();
        allow write: if hasSpacePermission(spaceId, 'vice-manager');

        match /receipts/{receiptId} {
          allow read: if isAuthenticated();
          allow write: if isAuthenticated();
        }
      }

      // ì„¤ì • (settings)
      match /settings/{settingId} {
        allow read: if isAuthenticated();
        allow write: if hasSpacePermission(spaceId, 'manager');
      }

      // ê²ŒìŠ¤íŠ¸ ì •ì±… (guestPolicies)
      match /guestPolicies/{policyId} {
        allow read: if isAuthenticated();
        allow write: if hasSpacePermission(spaceId, 'manager');
      }
    }
  }
}
